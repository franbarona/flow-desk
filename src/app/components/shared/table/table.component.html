<div class="mb-8 overflow-x-auto">
  <!-- Loading Spinner -->
  @if (loading || config.loading) {
  <div class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10">
    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
  </div>
  }

  <!-- Search -->
  @if (config.searchable) {
  <div class="mb-4 flex items-center gap-10 sticky left-0">
    <div class="relative flex-1">
      <input
        type="text"
        [value]="searchTerm || currentSearchTerm"
        (input)="onSearchChange($event)"
        [placeholder]="config.searchPlaceholder"
        class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-transparent bg-white placeholder-gray-300"
      />

      <!-- Search icon -->
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <app-icon [icon]="'search'" />
      </div>

      <!-- Clean button -->
      @if (currentSearchTerm || searchTerm) {
      <button
        (click)="clearSearch()"
        class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer"
      >
        <app-icon [icon]="'close'" />
      </button>
      }
    </div>

    <!-- Results counter -->
    <div class="text-sm text-gray-500">
      {{ processedData.length }} de {{ data.length }} results
    </div>
  </div>
  }

  <!-- Table -->
  <table class="w-full overflow-hidden bg-white shadow-md rounded-lg ">
    <!-- Header -->
    @if (config.showHeader !== false) {
    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
      <tr>
        @for (column of columns; track $index) {
        <th
          [ngClass]="[
            'px-6 py-3',
            column.headerClass || '',
            column.sortable ? 'cursor-pointer hover:bg-gray-100 select-none' : '',
            column.align === 'center'
              ? 'text-center'
              : column.align === 'right'
              ? 'text-right'
              : 'text-left'
          ]"
          [style.width]="column.width"
          (click)="onColumnClick(column)"
        >
          <div class="flex items-center gap-1">
            <span>{{ column.title }}</span>

            <!-- Short icons -->
            @if (column.sortable) {
            <div class="flex flex-col">
              <svg
                class="w-3 h-3"
                [ngClass]="
                  sortColumn === column && sortDirection === 'asc'
                    ? 'text-blue-600'
                    : 'text-gray-400'
                "
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z"
                  clip-rule="evenodd"
                />
              </svg>
              <svg
                class="w-3 h-3 -mt-1"
                [ngClass]="
                  sortColumn === column && sortDirection === 'desc'
                    ? 'text-blue-600'
                    : 'text-gray-400'
                "
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            }
          </div>
        </th>
        }

        <!-- Column actions -->
        @if (actions && actions.length > 0) {
        <th class="px-6 py-3 text-center"></th>
        }
      </tr>
    </thead>
    }

    <!-- Body -->
    <tbody>
      <!-- Data row -->
      @for (row of processedData; track $index) {
      <tr [ngClass]="rowClasses" (click)="onRowClick(row, $index)">
        <!-- Data cell -->
        @for (column of columns; track $index) {
        <td
          [ngClass]="[
            'px-2 py-2 lg:px-6 lg:py-4 text-normal',
            config.compact ? 'py-2' : 'py-4',
            column.cellClass || '',
            column.align === 'center'
              ? 'text-center'
              : column.align === 'right'
              ? 'text-right'
              : 'text-left'
          ]"
        >
          <!-- Template customized by column -->
          @if (column.cellTemplate) {
            <ng-container
              *ngTemplateOutlet="
                column.cellTemplate;
                context: buildTemplateContext(row, column, $index)
              "
            >
            </ng-container>
          } @else {
            <!-- Template customized global -->
            <ng-container *ngIf="customCellTemplate; else defaultCell">
              <ng-container
                *ngTemplateOutlet="
                  customCellTemplate;
                  context: {
                    $implicit: getCellValue(row, column),
                    row: row,
                    column: column,
                    index: $index
                  }
                "
              >
              </ng-container>
            </ng-container>

            <!-- Template by default -->
            <ng-template #defaultCell>
              <span [innerHTML]="getCellValue(row, column)"></span>
            </ng-template>
          }
        </td>
        }

        <!-- Cell actions -->
        @if (actions && actions.length > 0) {
        <td class="px-6 py-4">
          <!-- Template personalizado para acciones -->
          <ng-container *ngIf="customActionTemplate; else defaultActions">
            <ng-container
              *ngTemplateOutlet="
                customActionTemplate;
                context: {
                  $implicit: row,
                  actions: actions,
                  index: $index
                }
              "
            >
            </ng-container>
          </ng-container>

          <!-- Template actions by default -->
          <ng-template #defaultActions>
            <div class="flex items-center justify-end gap-2">
              @for (action of actions; track $index) { @if (shouldShowAction(action, row)) {
              <button
                [disabled]="isActionDisabled(action, row)"
                [ngClass]="[
                  'p-2 text-sm rounded-md font-medium transition-colors cursor-pointer',
                  'disabled:opacity-50 disabled:cursor-not-allowed',
                  action.class || 'hover:bg-gray-200 text-gray-600 disabled:text-gray-300'
                ]"
                (click)="onActionClick(action, row, $index, $event)"
              >
                <!-- Action icon -->
                @if (action.icon) {
                <app-icon [icon]="action.icon" />
                }
                @if (action.label.length > 0) {
                  <span class="ml-1">
                    {{ action.label }}
                  </span>
                }
              </button>
              } }
            </div>
          </ng-template>
        </td>
        }
      </tr>

      <!-- Empty state row -->
      @if (processedData.length === 0 && !loading && !config.loading) {
      <tr>
        <td
          [attr.colspan]="columns.length + (actions?.length ? 1 : 0)"
          class="px-6 py-8 text-center text-gray-500"
        >
          <div class="flex flex-col items-center gap-2">
            <svg
              class="w-12 h-12 text-gray-300"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1"
                d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2M4 13h2m13-8l-8 8-4-4m0 9l4-4 8 8-8-8z"
              />
            </svg>
            <p>{{ emptyMessage || config.emptyMessage }}</p>
          </div>
        </td>
      </tr>
      } }
    </tbody>
  </table>
</div>