<div class="relative w-full">
  <!-- Botón/Contenedor principal -->
  <div
    (click)="toggleDropdown()"
    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-white text-left text-gray-900 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors cursor-text"
  >
    <!-- Contenedor flex para tags, input y chevron -->
    <div class="flex items-center justify-between gap-2">
      <!-- Tags e input de búsqueda -->
      <div class="flex flex-wrap items-center gap-2 flex-1 min-h-[1.5rem]">
        <!-- Si hay items seleccionados mostrar tags -->
        <ng-container *ngIf="selectedItems.length > 0">
          <div
            *ngFor="let item of selectedItems"
            class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs whitespace-nowrap"
          >
            <img [src]="item.avatarUrl" [alt]="item.name" class="w-4 h-4 rounded-full object-cover" />
            <span>{{ item.name }}</span>
            <button
              type="button"
              (click)="removeItem(item); $event.stopPropagation()"
              class="text-blue-600 hover:text-blue-800 transition-colors ml-1 flex-shrink-0"
            >
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
          </div>
        </ng-container>

        <!-- Input de búsqueda -->
        <input
          #searchInput
          type="text"
          placeholder="Buscar usuarios..."
          [(ngModel)]="searchText"
          (input)="onSearchChange(searchText)"
          (click)="!isOpen && toggleDropdown(); $event.stopPropagation()"
          [autofocus]="isOpen"
          class="flex-1 min-w-[150px] px-0 py-0 border-0 outline-none text-gray-900 placeholder-gray-500 bg-transparent focus:ring-0"
        />

        <!-- Si no hay items ni input mostrar placeholder -->
        <span *ngIf="selectedItems.length === 0 && searchText === ''" class="text-gray-500">
          {{ placeholder }}
        </span>
      </div>

      <!-- Chevron -->
      <svg
        class="w-5 h-5 text-gray-400 transition-transform flex-shrink-0"
        [class.rotate-180]="isOpen"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
      </svg>
    </div>
  </div>

  <!-- Dropdown menu -->
  <div
    *ngIf="isOpen"
    class="absolute top-full left-0 right-0 mt-2 bg-white border border-gray-300 rounded-lg shadow-lg z-50"
  >
    <!-- Opciones -->
    <div class="max-h-64 overflow-y-auto">
      <div
        *ngIf="filteredItems.length === 0"
        class="p-4 text-center text-gray-500"
      >
        No se encontraron usuarios
      </div>

      <button
        *ngFor="let item of filteredItems"
        type="button"
        (click)="toggleItem(item)"
        class="w-full px-4 py-3 text-left hover:bg-blue-50 transition-colors border-b border-gray-100 last:border-0 flex items-center gap-3"
        [class.bg-blue-50]="isSelected(item)"
      >
        <!-- Checkbox -->
        <div class="flex-shrink-0">
          <input
            type="checkbox"
            [checked]="isSelected(item)"
            class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer"
            (click)="$event.stopPropagation()"
          />
        </div>

        <!-- Avatar -->
        <img [src]="item.avatarUrl" [alt]="item.name" class="w-8 h-8 rounded-full object-cover flex-shrink-0" />

        <!-- Nombre -->
        <span class="flex-grow text-gray-900">{{ item.name }} {{ item.surnames }}</span>
      </button>
    </div>

    <!-- Footer con botón limpiar -->
    <div
      *ngIf="selectedItems.length > 0"
      class="p-3 border-t border-gray-200 flex justify-between"
    >
      <button
        type="button"
        (click)="clearAll()"
        class="text-sm text-red-600 hover:text-red-800 font-medium transition-colors"
      >
        Limpiar todo
      </button>
      <span class="text-sm text-gray-600">{{ selectedItems.length }} seleccionados</span>
    </div>
  </div>

  <!-- Overlay para cerrar dropdown -->
  <div
    *ngIf="isOpen"
    (click)="isOpen = false"
    class="fixed inset-0 z-40"
  >
  </div>
</div>