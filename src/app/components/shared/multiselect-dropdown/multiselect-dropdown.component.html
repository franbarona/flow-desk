<div class="relative w-full">
  <!-- Main container -->
  <div
    (click)="toggleDropdown()"
    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-white text-left text-gray-900 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors cursor-pointer"
  >
    <!-- Flex for tags, input & chevron -->
    <div class="flex items-center justify-between gap-2">
      <!-- Tags & search input -->
      <div class="flex flex-wrap items-center gap-2 flex-1 min-h-[1.5rem]">
        <!-- If items selected, show tags -->
        @if (selectedItems.length > 0) {
        <ng-container>
          @for (item of selectedItems; track $index) {
          <div
            class="inline-flex items-center gap-2 px-2 py-1 border border border-gray-300 bg-gray-light text-black rounded-lg text whitespace-nowrap"
          >
            @if (item.avatarUrl) {
              @if (item.avatarUrl.trim() !== '') {
              <img
                [src]="item.avatarUrl"
                [alt]="item.label"
                class="w-5 h-5 rounded-full object-cover"
              />
              } @else {
              <div
                class="w-5 h-5 rounded-full bg-blue-500 text-white flex items-center justify-center text-[.6em] font-medium"
              >
                {{ item.label.charAt(0).toUpperCase()
                }}{{ item.extraLabel?.charAt(0)?.toUpperCase() }}
              </div>
              }
            }
            @if (item.color) {
              <div
                class="w-5 h-5 rounded-full"
                [class]="`bg-${item.color}`"
              >
                {{ item.label.charAt(0).toUpperCase()
                }}{{ item.extraLabel?.charAt(0)?.toUpperCase() }}
              </div>
            }
            <span>{{ item.label }}</span>
            <button
              type="button"
              (click)="removeItem(item); $event.stopPropagation()"
              class="text-gray-light hover:text-gray-700 transition-colors flex-shrink-0 cursor-pointer hover:scale-[1.1]"
            >
              <app-icon [icon]="'close'" class="cursor-pointer"></app-icon>
            </button>
          </div>
          }
        </ng-container>
        }

        <!-- Search input -->
        <input
          #searchInput
          type="text"
          [placeholder]="isOpen ? 'Search users...' : selectedItems.length === 0 ? placeholder : ''"
          [(ngModel)]="searchText"
          (input)="onSearchChange(searchText)"
          (click)="!isOpen && toggleDropdown(); $event.stopPropagation()"
          [autofocus]="isOpen"
          class="flex-1 min-w-[150px] px-0 py-0 border-0 outline-none text-gray-900 placeholder-gray-500 bg-transparent focus:ring-0 cursor-pointer"
        />
      </div>

      <!-- Chevron -->
      <button type="button" class="cursor-pointer">
        <app-icon
          [icon]="'keyboard_arrow_down'"
          [size]="22"
          class="text-gray-light transition-all duration-200 ease-in-out flex"
          [class.rotate-180]="isOpen"
        />
      </button>
    </div>
  </div>

  <!-- Dropdown menu -->
  @if (isOpen) {
  <div
    class="absolute top-full left-0 right-0 mt-2 bg-white border border-gray-300 rounded-lg shadow-lg z-50"
  >
    <!-- Opciones -->
    <div class="max-h-64 overflow-y-auto">
      @if (filteredItems.length === 0) {
      <div class="p-4 text-center text-gray-500">Users not found</div>
      } @for (item of filteredItems; track $index) {
      <button
        type="button"
        (click)="toggleItem(item)"
        class="w-full px-4 py-3 text-left transition-colors border-b border-gray-100 last:border-0 flex items-center gap-3 cursor-pointer"
        [class]="isSelected(item) ? 'bg-lime-light' : ''"
      >
        <!-- Avatar -->
        @if (item.avatarUrl && item.avatarUrl.trim() !== '') {
        <img
          [src]="item.avatarUrl"
          [alt]="item.label"
          class="w-8 h-8 rounded-full object-cover flex-shrink-0"
        />
        } @else {
        <div
          class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-[1em] font-medium"
        >
          {{ item.label.charAt(0).toUpperCase() }}{{ item.extraLabel?.charAt(0)?.toUpperCase() }}
        </div>
        }

        <!-- Name -->
        <span class="flex-grow text-gray-900">{{ item.label }} {{ item.extraLabel }}</span>
      </button>
      }
    </div>

    <!-- Footer with clear all button -->
    @if (selectedItems.length > 0) {
    <div class="p-3 border-t border-gray-200 flex justify-between">
      <button
        type="button"
        (click)="clearAll()"
        class="text-sm text-red-600 hover:text-red-800 font-medium transition-colors"
      >
        Clear all
      </button>
      <span class="text-sm text-gray-600">{{ selectedItems.length }} selected</span>
    </div>
    }
  </div>
  }

  <!-- Overlay close dropdown -->
  @if (isOpen) {
  <div (click)="closeDropdown(); searchText = ''" class="fixed inset-0 z-40"></div>
  }
</div>
